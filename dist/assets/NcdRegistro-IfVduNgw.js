import{j as e,r as s}from"./react-C-yax-zd.js";import{o as K}from"./@hookform-CI7dTiWF.js";import{b as V,u as $}from"./react-hook-form-Cc6cmx_T.js";import{B as Q}from"./react-toastify-Bq65RiZx.js";import{S as _}from"./sweetalert2-CxYvYGPM.js";import{w as H}from"./sweetalert2-react-content-BL0HHBIv.js";import{S as W}from"./SimpleContainer-tFVAehGQ.js";import{R as J}from"./RepresentacionGraficaUrls-DrGrKeqi.js";import{B as X}from"./Breadcrumb-BAVYU1BR.js";import{A as Y,b as Z,o as D,u as ee,q as te,s as ae,a as oe}from"./index-eXxrUaeE.js";import{n as re}from"./notification-CZdNX9HX.js";import{g as ie,G as ne}from"./graphql-request-rGYrdPjm.js";import{s as se,c as T,a as le,e as ce,d as R}from"./yup-DbVgGITq.js";import{e as de}from"./yup-locales-C3yB5wWh.js";import{I as me}from"./rc-input-number-DHeBSjOn.js";import{n as f}from"./NumberInput-ChEcYOmf.js";import{S as N}from"./SimpleCard-Cf1MrNuW.js";import{aJ as d,aG as ue,b2 as pe,a5 as he,a6 as fe,a7 as xe,ae as ge,bj as je,bl as Ce,bm as A,g as I,a8 as Se,e as be,P as Fe,k as De,bq as Ie,aN as we}from"./@mui-Cg5JgIJd.js";import{F}from"./FormTextField-DeIeSGMe.js";import{e as ye}from"./@tanstack-CH50zjZF.js";import{M as z,a as Te}from"./material-react-table-B3_JpHKP.js";import{S as Re,a as w}from"./SimpleMenu-bKr1ysvp.js";import{P as E}from"./index-CmjSjgDW.js";import{f as Ae}from"./factura.listado.api-DJlaXX2Z.js";import{M as Ee}from"./muiTableAdvancedOptionsProps-8HbDsjdr.js";import{b as Ne}from"./materialReactTableUtils-RKRDldrD.js";import"./@babel-BWOPM2cf.js";import"./clsx-B-dksMZM.js";import"./react-dom-BMaWjgIA.js";import"./scheduler-CzFDRTuY.js";import"./react-router-dom-BXf9Krd-.js";import"./react-router-m6rhPc7O.js";import"./@remix-run-DEp2-txB.js";import"./react-datepicker-D7PCQ8zk.js";import"./date-fns-9p2ure4y.js";import"./react-onclickoutside-vgQ6ifgl.js";import"./@floating-ui-BqRERJ-b.js";import"./perfect-scrollbar-BfaLzep3.js";import"./lodash-Dwhj6_6J.js";import"./jwt-decode-VWaDGczM.js";import"./nanoid-CeQjyfxW.js";import"./@rc-component-BLzWySNC.js";import"./classnames-F3cnkUDL.js";import"./rc-input-CDxr26_S.js";import"./rc-util-RNQGGLoE.js";import"./react-is-DcfIKM1A.js";import"./@emotion-D9k8Qpvi.js";import"./hoist-non-react-statics-DQogQWOa.js";import"./stylis-NkKAe6Bn.js";import"./react-transition-group-C1IEqfrK.js";import"./dom-helpers-D0mFdbeO.js";import"./prop-types-tGFuYKac.js";import"./@popperjs-BQBsAJpH.js";import"./graphql-BS3ZITc9.js";import"./cross-fetch-Ml2K_YIJ.js";import"./property-expr-DEi1ZLzV.js";import"./tiny-case-BJ7jYKNY.js";import"./toposort-CW3e93qZ.js";import"./Typography-SNySdv6H.js";import"./highlight-words-DHKmS53s.js";const ze=ie`
  mutation NCD_ALQ_REGISTRO($input: NotaDebitoCreditoAlqInput!) {
    notaCreditoDebitoAlqRegistro(input: $input) {
      cuf
      state
      numeroFactura
      numeroNotaCreditoDebito
      representacionGrafica {
        pdf
        rollo
        xml
        sin
      }
    }
  }
`,Oe=async r=>{const i=new ne("https://sandbox.isipass.net/api"),o=localStorage.getItem(Y);return i.setHeader("authorization",`Bearer ${o}`),(await i.request(ze,{input:r})).notaCreditoDebitoAlqRegistro},Pe=r=>({facturaCuf:r.facturaCuf,detalle:r.detalleFactura.map(i=>({itemFactura:i.nroItem,cantidad:i.cantidad}))});se(de);const ve=T({facturaCuf:le().trim().required("Código Único de factura es requerido"),detalleFactura:ce().of(T({nroItem:R().required("Debbe Seleccionar un item"),cantidad:R().required()}))}),ke=r=>{const{form:{control:i,getValues:o,formState:{errors:l}}}=r,{update:x}=V({control:i,name:"detalleFactura"});return e.jsx(e.Fragment,{children:e.jsx(N,{title:"DATOS DE LA DEVOLUCIÓN",children:e.jsx(d,{container:!0,spacing:3,children:e.jsx(d,{item:!0,lg:12,md:12,xs:12,sx:{pt:10},children:e.jsx("div",{className:"responsive-table",style:{marginTop:20},children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",style:{width:100},children:"NRO. ITEM"}),e.jsx("th",{scope:"col",style:{width:160},children:"CANTIDAD"}),e.jsx("th",{scope:"col",children:"DESCRIPCION"}),e.jsx("th",{scope:"col",style:{width:160},children:"PRECIO UNITARIO"}),e.jsx("th",{scope:"col",style:{width:160},children:"DESCUENTO"})]})}),e.jsx("tbody",{children:o("detalleFactura").length>0&&o("detalleFactura").map((a,m)=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"NRO.ITEM",children:a.nroItem}),e.jsx("td",{"data-label":"CANTIDAD",children:e.jsx(me,{min:.1,max:a.cantidadOriginal,value:a.cantidad,onChange:n=>{n&&n>=0&&x(m,{...a,cantidad:n})},formatter:f})}),e.jsx("td",{"data-label":"DESCRIPCIÓN",children:a.descripcion}),e.jsx("td",{"data-label":"PRECIO",style:{textAlign:"right"},children:f(a.precioUnitario,{})}),e.jsx("td",{"data-label":"DESCUENTO",style:{textAlign:"right"},children:f(a.montoDescuento,{})})]},a.nroItem))})]})})})})})})},Be=[{header:"Número",accessorKey:"numeroFactura",size:120},{accessorKey:"fechaEmision",header:"Fecha Emisión",id:"fechaEmision",size:150,enableColumnFilter:!1},{header:"Importe",accessorKey:"montoTotal",muiTableBodyCellProps:{align:"right"},Cell:({cell:r})=>e.jsx("span",{children:f(r.getValue(),{})}),size:100,enableColumnFilter:!1},{header:"Razon Social",id:"cliente.razonSocial",accessorKey:"cliente.razonSocial",maxSize:180},{id:"cliente.numeroDocumento",header:"Nro. Documento",accessorFn:r=>e.jsxs("span",{children:[r.cliente.numeroDocumento," ",r.cliente.complemento?`-${r.cliente.complemento}`:""]}),filterFn:(r,i,o)=>r.original.cliente.numeroDocumento.startsWith(o)},{accessorKey:"cuf",id:"cuf",header:"C.U.F."},{accessorKey:"state",id:"state",header:"ESTADO"}],qe=r=>{const{onClose:i,open:o,...l}=r,x=()=>{i()},[a,m]=s.useState([]),[n,u]=s.useState({pageIndex:E.page,pageSize:5}),[g,j]=s.useState(0),[p,C]=s.useState(!1),[t,b]=s.useState([]);s.useState("");const[S,h]=s.useState({}),{data:O,isError:y,isLoading:P,refetch:Ge}=ye({queryKey:["NcdGestionFacturas",a,n.pageIndex,n.pageSize,t],queryFn:async()=>{const c=Z(a,["state=VALIDADA"]),G={...E,page:n.pageIndex+1,limit:n.pageSize,reverse:t.length<=0,query:c},{pageInfo:U,docs:L}=await Ae(G);return j(U.totalDocs),L}}),v=s.useMemo(()=>Be,[]),k=c=>{i(c)},B=ue(pe)(({theme:c})=>({backdropFilter:"blur(5px)",backgroundColor:"rgba(255, 255, 255, 0.5)",zIndex:c.zIndex.drawer+1})),q=()=>{i()},M=c=>{c.key==="Escape"&&i()};return e.jsx(e.Fragment,{children:e.jsxs(he,{sx:{"& .MuiDialog-paper":{width:"100%",maxHeight:550}},maxWidth:"lg",open:o,onClose:q,onKeyDown:M,BackdropComponent:B,...l,children:[e.jsx(fe,{children:"Seleccione su Factura"}),e.jsx(xe,{dividers:!0,children:e.jsx(z,{...Ee,columns:v,data:O??[],initialState:{showColumnFilters:!0,columnVisibility:{cuf:!1,state:!1}},manualFiltering:!0,manualPagination:!0,manualSorting:!0,muiToolbarAlertBannerProps:y?{color:"error",children:"Error loading data"}:void 0,onColumnFiltersChange:m,onPaginationChange:u,onSortingChange:b,enableDensityToggle:!1,enableGlobalFilter:!1,rowCount:g,state:{isLoading:P,columnFilters:a,pagination:n,showAlertBanner:y,showProgressBars:p,density:"compact",sorting:t,rowSelection:S},muiSearchTextFieldProps:{variant:"outlined",placeholder:"Busqueda",InputLabelProps:{shrink:!0},size:"small"},enableRowActions:!0,positionActionsColumn:"first",renderRowActions:({row:c})=>e.jsxs(e.Fragment,{children:[e.jsxs(Re,{menuButton:e.jsx(e.Fragment,{children:e.jsx(ge,{"aria-label":"delete",children:e.jsx(je,{})})}),children:[e.jsxs(w,{onClick:()=>{D(c.original.representacionGrafica.pdf)},children:[e.jsx(Ce,{})," Pdf Medio Oficio"]}),e.jsxs(w,{onClick:()=>{D(c.original.representacionGrafica.xml)},children:[e.jsx(A,{})," Xml"]}),e.jsxs(w,{onClick:()=>{D(c.original.representacionGrafica.sin)},children:[e.jsx(A,{})," Url S.I.N."]})]}),e.jsx(I,{size:"small",variant:"contained",color:"info",onClick:()=>k(c.original),style:{width:"70px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",fontSize:"12px"},children:"Seleccionar"})]}),muiTableProps:{sx:{tableLayout:"fixed"}},displayColumnDefOptions:{"mrt-row-actions":{muiTableHeadCellProps:{align:"center"},size:120}}})}),e.jsx(Se,{children:e.jsx(I,{autoFocus:!0,color:"error",size:"small",variant:"contained",onClick:x,children:"Cerrar"})})]})})},Me=r=>{const{form:{control:i,setValue:o,getValues:l,watch:x,formState:{errors:a}}}=r,[m,n]=s.useState(!1),[u,g]=s.useState({}),[j,p]=s.useState([]),C=s.useMemo(()=>[{id:"Nro. Item",header:"Nro. Item",accessorFn:t=>t.nroItem,width:"100px"},{id:"Cantidad",header:"Cantidad",accessorFn:t=>t.cantidad,width:"100px"},{id:"Descripción",header:"Descripción",accessorFn:t=>t.descripcion,width:"100px"},{id:"Descuento",header:"Descuento",accessorFn:t=>f(t.montoDescuento,{}),right:!0,width:"160px"},{id:"Precio Unitario",header:"Precio Unitario",accessorFn:t=>f(t.precioUnitario,{}),right:!0,width:"160px"},{id:"Sub Total",header:"Sub Total",accessorFn:t=>f(t.subTotal,{}),right:!0,width:"160px"}],[]);return s.useEffect(()=>{p([]),o("detalleFactura",[])},[]),s.useEffect(()=>{if(u){const t=Object.keys(u);if(t.length>0){const b=l("detalle").filter(S=>t.includes(S.nroItem.toString()));if(b.length>0){const S=b.map(h=>({nroItem:h.nroItem,cantidadOriginal:h.cantidad,cantidad:h.cantidad,descripcion:h.descripcion,montoDescuento:h.montoDescuento,precioUnitario:h.precioUnitario,subTotal:h.subTotal}));o("detalleFactura",S)}else o("detalleFactura",[])}else o("detalleFactura",[])}},[u]),e.jsxs(e.Fragment,{children:[e.jsx(N,{title:"DATOS DE LA FACTURA ORIGINAL",children:e.jsxs(d,{container:!0,spacing:3,children:[e.jsxs(d,{item:!0,lg:12,children:[e.jsx(I,{size:"small",variant:"contained",color:"info",onClick:()=>n(!0),children:"Seleccionar Factura"}),e.jsx("hr",{})]}),e.jsx(d,{item:!0,lg:2,md:2,xs:12,children:e.jsx(F,{name:"numeroFactura",label:"Número Factura",value:l("numeroFactura"),autoComplete:"off"})}),e.jsx(d,{item:!0,lg:4,md:4,xs:12,children:e.jsx(F,{name:"fechaEmision",label:"Fecha Emisión",value:l("fechaEmision")})}),e.jsx(d,{item:!0,lg:6,md:6,xs:12,children:e.jsx(F,{name:"razonSocial",label:"Razon Social",value:l("razonSocial")})}),e.jsx(d,{item:!0,lg:12,md:12,xs:12,children:e.jsx(F,{name:"cuf",label:"Código Control (C.U.F.)",value:l("facturaCuf")})}),e.jsxs(d,{item:!0,lg:12,md:12,xs:12,sx:{pt:10},children:[e.jsx(be,{gutterBottom:!0,variant:"subtitle1",children:"Detalle"}),e.jsx(z,{...Ne,columns:C,data:l("detalle")||[],localization:Te,enableBottomToolbar:!1,state:{rowSelection:u,density:"comfortable"},enableTopToolbar:!1,enableRowSelection:!0,onRowSelectionChange:g,getRowId:t=>t.nroItem.toString(),muiTableBodyRowProps:({row:t})=>({onClick:t.getToggleSelectedHandler(),sx:{cursor:"pointer"}})})," "]})]})}),e.jsx(e.Fragment,{children:e.jsx(qe,{id:"ncdFacturaOriginalDialogSeleccion",keepMounted:!1,open:m,onClose:t=>{n(!1),t&&(o("numeroFactura",t.numeroFactura.toString()),o("fechaEmision",t.fechaEmision),o("razonSocial",t.cliente.razonSocial),o("facturaCuf",t.cuf),o("detalleFactura",[]),o("detalle",t.detalle),p([]))}})})]})},_t=()=>{ee();const r=H(_),i=$({defaultValues:{numeroFactura:"",fechaEmision:"",razonSocial:"",facturaCuf:"",detalleFactura:[],detalle:[]},resolver:K(ve)}),o=async l=>{const x=Pe(l);await ae({preConfirm:async()=>{var m,n,u,g,j;const a=await Oe(x).catch(p=>({error:p}));if(a!=null&&a.error){const p=((j=(g=(u=(n=(m=a.error)==null?void 0:m.response)==null?void 0:n.data)==null?void 0:u.data)==null?void 0:g[0])==null?void 0:j.field)??"unknown field",C="El campo es requerido.";return Q.error(C),i.setError(p,{message:C}),!1}return a}}).then(a=>{if(a.isConfirmed){const{value:m}=a,{representacionGrafica:n}=m;r.fire({title:"Documento Generado Correctamente",html:e.jsx(J,{representacionGrafica:n})}),i.reset({numeroFactura:"",fechaEmision:"",razonSocial:"",facturaCuf:"",detalleFactura:[]}),re(),D(n.pdf)}a.isDenied&&oe(a.value)})};return e.jsxs(W,{children:[e.jsx("div",{className:"breadcrumb",children:e.jsx(X,{routeSegments:[{name:"Notas Crédito Debito",path:te.gestion},{name:"Registrar Nota"}]})}),e.jsx(Fe,{elevation:0,variant:"elevation",square:!0,sx:{mb:2,p:.5},className:"asideSidebarFixed",children:e.jsx(De,{direction:{xs:"column",sm:"row"},style:{marginTop:2},spacing:{xs:1,sm:1,md:1,xl:1},justifyContent:"flex-end",children:e.jsx(I,{color:"success",startIcon:e.jsx(Ie,{}),variant:"contained",onClick:i.handleSubmit(o),children:"Registrar Nota"})})}),e.jsx("form",{children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsx(d,{item:!0,lg:12,children:e.jsx(Me,{form:i})}),e.jsx(d,{item:!0,lg:12,children:e.jsx(ke,{form:i})})]})}),e.jsx(we,{py:"12px"})]})};export{_t as default};
